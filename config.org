#+Title: My emacs config
#+Author: Dhia Dahmeni
#+Date: 2025
#+PROPERTY: header-args :tangle init.el

* Required settings
These settings are the barebones to using emacs, they also don't require any packages

#+BEGIN_SRC emacs-lisp

  (add-to-list 'default-frame-alist '(fullscreen . maximized))
  (setq gc-cons-threshold (* 50 1000 1000))
  (setq ring-bell-function 'ignore)
  (defun crypt/display-startup-time ()
    (message "Emacs loaded in %s with %d garbage collections."
             (format "%.2f seconds"
                     (float-time
                      (time-subtract after-init-time before-init-time)))
             gcs-done))

  (add-hook 'emacs-startup-hook #'crypt/display-startup-time)

  ;; Silence native compiler warnings
  (setq native-comp-async-report-warnings-errors nil)

  ;; Set the right directory to store native comp cache
  (add-to-list 'native-comp-eln-load-path (expand-file-name "eln-cache/" user-emacs-directory))

  (set-language-environment "UTF-8")

  (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
  (load custom-file)

  (global-auto-revert-mode t)

  (add-to-list 'exec-path "/opt/homebrew/bin")

  (setenv "PATH" (concat "/opt/homebrew/bin:" (getenv "PATH")))


  (add-to-list 'exec-path "/Users/macbook/.local/bin")

  (setenv "PATH" (concat "/Users/macbook/.local/bin" (getenv "PATH")))
#+END_SRC

* Package manager
For package management I'm using straight.el
#+BEGIN_SRC emacs-lisp 
  ;; Initialize package sources
  (setq straight-repository-branch "master")

  ;; Install straight.el
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
        (bootstrap-version 6))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
      	  (url-retrieve-synchronously
      	   "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
      	   'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))

  ;; Prefer built-in packages
  (dolist (pkg '(project xref eldoc flymake jsonrpc eglot))
    (straight-override-recipe `(,pkg :type built-in)))
  ;; Install use-package
  (straight-use-package 'use-package)

  ;; Configure use-package to use straight.el by default
  (use-package straight
    :custom
    (straight-use-package-by-default t))
#+END_SRC

* UI and garbage/temp file handling

#+begin_src emacs-lisp

  ;; backup and auto-save files in one single room
  (setq backup-directory-alist
        `(("." . ,(concat user-emacs-directory "backup"))))

  (use-package no-littering)

  (setq inhibit-startup-message t)

  (scroll-bar-mode -1) ;Disable scrollb
  (tool-bar-mode -1) ; Disable toolbar
  (tooltip-mode -1) ; Disable tooltips
  (set-fringe-mode 10) ; Give some room

  (menu-bar-mode -1) ; Disable menu bar

  (column-number-mode)
  (global-display-line-numbers-mode t)

  ;; Disable line numbers for some modes
  (dolist (mode '(org-mode-hook
                  term-mode-hook
                  shell-mode-hook
                  eshell-mode-hook
                  pdf-view-mode-hook))
    (add-hook mode (lambda () (display-line-numbers-mode 0))))

  (set-face-attribute 'default nil :font "Hack" :height 160)

(use-package doom-themes
  :ensure t
  :config
  ;; Global settings (defaults)
  (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
        doom-themes-enable-italic t) ; if nil, italics is universally disabled
  (load-theme 'doom-gruvbox t)

  ;; Enable flashing mode-line on errors
  (doom-themes-visual-bell-config)
  ;; Enable custom neotree theme (nerd-icons must be installed!)
  (doom-themes-neotree-config)
  ;; or for treemacs users
  (setq doom-themes-treemacs-theme "doom-atom") ; use "doom-colors" for less minimal icon theme
  (doom-themes-treemacs-config)
  ;; Corrects (and improves) org-mode's native fontification.
  (doom-themes-org-config))
  ;; Transperancy
  (add-to-list 'default-frame-alist '(alpha-background . 96)) ; For all new frames henceforth

  (use-package doom-modeline
    :init (doom-modeline-mode 1))

  ;; Add git  to the side
  (use-package git-gutter-fringe
    :init
    (global-git-gutter-mode t))

  (setq treesit-extra-load-path (list "~/.emacs.d/straight/build/tree-sitter-langs/bin"))
  ;; tree sitter langs for tree sitter integration
  (use-package tree-sitter-langs)

  ;; Tree sitter support
  (global-tree-sitter-mode)
  (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode)

  ;; smart parens
  (use-package smartparens
    :init (show-smartparens-global-mode)
    :config (require 'smartparens-config))

  ;; shows possible key combinations
  (use-package which-key
    :init (which-key-mode)
    :diminish which-key-mode
    :config
    (setq which-key-idle-delay 0.3))

  (use-package all-the-icons
    :if (display-graphic-p))

  (use-package all-the-icons-dired
    :hook (dired-mode . all-the-icons-dired-mode))

  ;; File tree

#+end_src

* Terminal
best terminal around
#+begin_src emacs-lisp
(use-package vterm
  :hook (vterm-mode . (lambda () (display-line-numbers-mode 0))))

#+end_src
* Undo
Because the undo system in emacs sucks balls, i'm using undo-tree
#+begin_src emacs-lisp
  (use-package undo-tree
    :init (global-undo-tree-mode)
    :config
    (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/backup/"))))
#+end_src

* Keybinds and EVIL

#+begin_src emacs-lisp

  (setq evil-want-C-u-scroll t)
  (setq evil-want-keybinding 'nil)


  (use-package evil
    :init (evil-mode 1))

  (use-package evil-commentary
    :init (evil-commentary-mode))

  (use-package evil-surround
    :config
    (global-evil-surround-mode 1))

  (use-package evil-collection
    :init (evil-collection-init))

  (use-package evil-owl
    :config
    (setq evil-owl-max-string-length 200)
    (add-to-list 'display-buffer-alist
                 '("*evil-owl*"
                   (display-buffer-in-side-window)
                   (side . bottom)
                   (window-height . 0.3)))
    (evil-owl-mode))


  (use-package general
    :after which-key
    :config
    (general-override-mode 1))


  (general-create-definer tyrant-def-1
    :states '(normal visual insert motion emacs)
    :prefix "SPC"
    :non-normal-prefix "C-SPC")

  (general-evil-setup t)

  (tyrant-def-1
    ""     nil
    "c"   (general-simulate-key "C-c")
    "h"   (general-simulate-key "C-h")
    "x"   (general-simulate-key "C-x")
    "w"   (general-simulate-key "C-w")
    "p"   (general-simulate-key "C-x p")
    "SPC"   'consult-buffer

    ;; searching files by consult
    "f"   '(:ignore t :which-key "files")
    "ff"  'consult-find
    ;; use ripgrep for searching
    "fg"  'consult-ripgrep

    ;; searching inside buffer
    "s"   '(:ignore t :which-key "search")
    "ss"  'consult-line
    "sb"  'consult-buffer

    ;; Package manager
    "lp"  'list-packages

    ;; Quit operations
    "q"	'(:ignore t :which-key "quit emacs")
    "qq"  'kill-emacs
    "qz"  'delete-frame

    ;; Buffer operations
    "b"   '(:ignore t :which-key "buffer")
    "bb"  'mode-line-other-buffer
    "bd"  (lambda () (interactive) (kill-this-buffer))
    "bD"  'vb/close-all-buffers
    "bq"  'kill-buffer-and-window
    "bR"  'rename-filand-buffer

    ;; Eglot equivalents for your LSP keybindings
    "l"  '(:ignore t :which-key "lsp")  ; Assuming this is a prefix label
    "ln" 'xref-find-references           ; Find references (Eglot uses xref)
    "ld" 'xref-find-definitions          ; Jump to definition (Eglot uses xref)
    "lh" 'eglot-help-at-point            ; Describe session/info at point
    "ls" 'consult-eglot-symbols          ; Find symbols (requires consult package)
    "lx" 'eglot-code-actions             ; Execute code actions
    "lR" 'eglot-reconnect                ; Restart/reconnect to server
    "lS" 'eglot-shutdown                 ; Shutdown server
    "lD" 'xref-find-definitions          ; No direct declaration support, using definition
    "lF" 'eglot-find-type-definition    ; Find type definition (server-dependent)
    "lI" 'eglot-find-implementation     ; Find implementation (server-dependent)
    "lT" 'eglot-find-type-definition    ; Find type definition (same as lF)
    "lU" 'xref-find-references           ; Find references (same as lr)
    "lW" 'eglot-format                   ; Organize imports or format (server-dependent)
    "lr" 'eglot-rename

    "e" '(:ignore t :which-key "errors")
    "en" 'flymake-goto-next-error
    "ep" 'flymake-goto-prev-error
    "el" 'consult-flymake

    "t" '(:ignore t :which-key "toggle")
    "td" 'dired
    "tg" 'magit-status
    "tv" 'vterm

    "o" '(:ignore t :which-key "org")
    "oa" 'org-agenda
    "oc" 'org-capture
    "ol" 'org-store-link
    "os" 'org-schedule
    "ot" 'org-todo
    "or" 'org-refile

    ;; magit && git
    "v" '(:ignore t :which-key "magit")
    "vb" 'magit-blame
    "vl" 'magit-log-buffer-file
    "vd" 'magit-diff-buffer-file
    "vc" 'magit-file-checkout
    "vs" 'magit-stage
    "vu" 'magit-unstage
    "vU" 'magit-file-untrack
    )


  ;; cycle through errors
  (evil-global-set-key 'normal (kbd "]d") 'flycheck-next-error)
  (evil-global-set-key 'normal (kbd "[d") 'flycheck-previous-error)

  (evil-global-set-key 'normal (kbd "C-u") 'evil-scroll-up)

  ;; cycle through buffers
  (evil-global-set-key 'normal (kbd "]b") 'next-buffer)
  (evil-global-set-key 'normal (kbd "[b") 'previous-buffer)

  (evil-set-undo-system 'undo-tree)

#+end_src

* Auto completion
For auto completion i'm using corfu, there are none better
#+begin_src emacs-lisp

  ;; Corfu with use-package
  (use-package corfu
    :ensure t  ; Automatically install from MELPA
    :init
    (global-corfu-mode)  ; Enable Corfu globally
    :bind
    (:map corfu-map
          ("TAB" . corfu-complete))  ; Complete selection with C-e
    :custom
    (corfu-auto t)               ; Enable auto-completion
    (corfu-auto-prefix 3)        ; Trigger after 3 characters
    (corfu-auto-delay 1.0)       ; Delay before showing completions
    (corfu-quit-no-match t))     ; Quit if no match

  ;; Text mode setup for ispell completion
  (defun text-mode-hook-setup ()
    "Customize completion backends for text modes."
    (make-local-variable 'completion-at-point-functions)
    (add-to-list 'completion-at-point-functions 'ispell-completion-at-point))

  ;; Apply to text-mode and org-mode
  (add-hook 'text-mode-hook 'text-mode-hook-setup)
  (add-hook 'org-mode-hook 'text-mode-hook-setup)

#+end_src

* Git integration

#+begin_src emacs-lisp
  (use-package magit)

  ;; Add git  to the side
  (use-package git-gutter-fringe
    :init
    (global-git-gutter-mode t))
#+end_src

* eshell config
#+begin_src emacs-lisp

  (defun crypt/configure-eshell ()
    ;; Save command history when commands are entered
    (add-hook 'eshell-pre-command-hook 'eshell-save-some-history)

    ;; Truncate buffer for performance
    (add-to-list 'eshell-output-filter-functions 'eshell-truncate-buffer)

    (setq eshell-history-size         10000
  	      eshell-buffer-maximum-lines 10000
  	      eshell-hist-ignoredups t
  	      eshell-scroll-to-bottom-on-input t))

  (use-package eshell
    :hook (eshell-first-time-mode . crypt/configure-eshell)
    :config

    (with-eval-after-load 'esh-opt
      (setq eshell-destroy-buffer-when-process-dies t)))
#+end_src

* Completion Popup
#+begin_src elisp
  (use-package vertico
    :init (vertico-mode)
    :demand t
    :bind (
  	       :map vertico-map
  	       ("C-j" . vertico-next)
  	       ("C-k" . vertico-previous))
    :config
    (setq vertico-sycle t))

  (use-package savehist
    :init
    (savehist-mode))

  (use-package orderless
    :init
    (setq completion-styles '(orderless)
  	      completion-category-defaults nil
  	      completion-category-overrides '((file (styles partial-completion)))))

  (use-package marginalia
    :bind (
  	       :map minibuffer-local-map
  	       ("M-A" . marginalia-cycle))
    :init
    (marginalia-mode))

  (use-package consult) 
#+end_src

* Org mode config

#+begin_src elisp
  (defun crypt/org-mode-setup ()
    (org-indent-mode 1)
    (variable-pitch-mode 1)
    (visual-line-mode 1))

  (use-package org
    :hook (org-mode . crypt/org-mode-setup)
    :config
    (setq org-agenda-files
  	      '("~/Documents/org/todo.org"))
    (setq org-agenda-start-with-log-mode t)
    (setq org-log-done 'time)
    (setq org-ellipsis " ▾")

    (setq org-capture-templates
  	      `(("t" "Tasks / Projects")
  	        ("tt" "Task" entry (file+olp "~/Documents/org/todo.org" "Inbox")
  	         "* TODO %?\n  %U\n  %a\n  %i" :empty-lines 1)

  	        ("j" "Journal Entries")
  	        ("jj" "Journal" entry
  	         (file+olp+datetree "~/Documents/org/journal.org")
  	         "\n* %<%I:%M %p> - Journal :journal:\n\n%?\n\n"
  	         :clock-in :clock-resume
  	         :empty-lines 1)
  	        ("jm" "Meeting" entry
  	         (file+olp+datetree "~/Documents/org/journal.org")
  	         "* %<%I:%M %p> - %a :meetings:\n\n%?\n\n"
  	         :clock-in :clock-resume
  	         :empty-lines 1))))

  (use-package org-bullets
    :after org
    :hook (org-mode . org-bullets-mode)
    :custom
    (org-bullets-bullet-list '("◉" "○" "●" "○" "●" "○" "●")))

  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (python . t)))

  (require 'org-tempo)
  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python"))

  (defun crypt/org-mode-visual-fill ()
    (setq visual-fill-column-width 500
  	      visual-fill-column-center-text t)
    (visual-fill-column-mode 1))

  (use-package visual-fill-column
    :hook (org-mode . crypt/org-mode-visual-fill))
#+end_src

* File manager

#+begin_src elisp
  (use-package dired
    :straight (:type built-in)
    :commands (dired dired-jump)
    :config (setq insert-directory-program "gls")
    :custom ((dired-listing-switches "-agho --group-directories-first")))

  (use-package dired-single)
#+end_src

* Programming
** Diagnostics and formatting
#+begin_src elisp
  (use-package format-all
    :preface
    (defun crypt/format-code ()
      "Auto-format whole buffer."
      (interactive)
      (if (derived-mode-p 'prolog-mode)
          (prolog-indent-buffer)
        (format-all-buffer)))
    :config
    (global-set-key (kbd "M-F") #'crypt/format-code)
    (add-hook 'prog-mode-hook #'format-all-ensure-formatter))
#+end_src

** Tools  

#+begin_src elisp

  (use-package docker
  	:defer t
  	:ensure t
  	:bind ("C-c d" . docker)
  	:config
  	(setq docker-command "docker"
  			  docker-compose-command "docker-compose"
  			  docker-container-tramp-method "docker"))
#+end_src

** LSP

#+begin_src elisp
(use-package eglot
  :straight (:type built-in)
  :ensure nil)
#+end_src

** Languages

*** Indent
#+begin_src elisp

  (setq-default tab-width 2)
  (setq-default indent-tabs-mode nil)
  (setq-default c-basic-offset 2)

#+end_src

*** Python
#+begin_src elisp
    (add-hook 'python-mode-hook 'eglot-ensure)  ; Python
  (add-to-list 'eglot-server-programs
              '((python-mode python-ts-mode)
              "basedpyright-langserver" "--stdio"))

#+end_src

*** TS/JS/Web

#+begin_src elisp

  (use-package web-mode
    :mode (("\\.html?\\'" . web-mode)
           ("\\.css\\'"   . web-mode)
           ("\\.jsx?\\'"  . web-mode)
           ("\\.tsx?\\'"  . web-mode)
           ("\\.json\\'"  . web-mode))
    :config
    (setq web-mode-markup-indent-offset 2) ; HTML
    (setq web-mode-css-indent-offset 2)    ; CSS
    (setq web-mode-code-indent-offset 2)   ; JS/JSX/TS/TSX
    (setq web-mode-content-types-alist '(("jsx" . "\\.js[x]?\\'"))))

  ;; js/ts Development
  (use-package typescript-mode)

  ;; Ensure Eglot starts for TypeScript
  (add-hook 'typescript-mode-hook 'eglot-ensure)
  (add-hook 'js-mode-hook 'eglot-ensure)

#+end_src

*** Rust

#+begin_src elisp

  (use-package rust-mode)

#+end_src

*** Zig

#+begin_src elisp
  (use-package zig-mode)

#+end_src

*** YAML

#+begin_src elisp
  (use-package yaml-mode)
  (use-package yaml-pro)
#+end_src

* PDF/Markdown
#+begin_src elisp

  (custom-set-variables
   '(markdown-command "/usr/bin/pandoc"))

  (use-package pdf-tools
    :config
    (pdf-tools-install)
    (setq-default pdf-view-display-size 'fit-width)
    (define-key pdf-view-mode-map (kbd "C-s") 'isearch-forward)
    :custom
    (pdf-annot-activate-created-annotations t "automatically annotate highlights"))

  (setq TeX-view-program-selection '((output-pdf "PDF Tools"))
        TeX-view-program-list '(("PDF Tools" TeX-pdf-tools-sync-view))
        TeX-source-correlate-start-server t)

  (add-hook 'TeX-after-compilation-finished-functions
            #'TeX-revert-document-buffer)

  (add-hook 'pdf-view-mode-hook (lambda() (linum-mode -1)))
#+end_src
* Misc
#+begin_src elisp

  (defun crypto/so-long()
    (setq-default bidi-paragraph-direction 'left-to-right)
    (setq bidi-inhibit-bpa t)
    )

  (global-so-long-mode 1)
  (add-hook 'so-long-hook #'crypto/so-long)

#+end_src


* Performance

#+begin_src elisp

  (setq read-process-output-max (* 3072 3072))
  (setq gc-cons-threshold 200000000)

#+end_src
